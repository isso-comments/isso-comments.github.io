<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Testing the Client</title> 
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/site.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/isso.svg"/>
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="top" title="Isso  documentation" href="../../../" />
    <link rel="next" title="Testing the Server" href="../testing-server/" />
    <link rel="prev" title="Development &amp; Testing" href="../testing/" />
</head>
<body>
    <div class="wrapper">
        <div class="header">
            <header>
                <img class="logo" src="../../../_static/isso.svg" alt="Wynaut by @veekun"/>
                <div class="title">
                    <a href="../../.././">
                        <h1>Isso</h1>
                        <h2>a commenting server similar to Disqus</h2>
                    </a>
                </div>
            </header>
            <nav>
                <a href="../../">Documentation</a>
                <a href="../../contributing/">Contribute</a>
                <a href="../../../community/">community</a>
            </nav>
        </div>

        <div class="outer">
            
    <header>
    </header>

        </div>


        <main>
        
            
          <div role="navigation" class="sidebar">
<div role="search" id="searchbox" style="display: none">
  <h2>Quick search</h2>
    <form class="search" action="../../../search/" method="get">
      <input type="text"
             name="q"
             aria-labelledby="searchlabel"
             autocomplete="off"
             autocorrect="off"
             autocapitalize="off"
             spellcheck="false"
      />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
    <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/quickstart/">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/tips-and-tricks/">Tips &amp; Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/advanced-integration/">Advanced Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/faq/">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/server-config/">Server Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/client-config/">Client Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/markdown-config/">Markdown Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/deployment/">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/multi-site-sub-uri/">Multiple Sites &amp; Sub-URI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/server-api/">Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/releasing/">Releasing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../server/">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/">Development &amp; Testing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing the Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-server/">Testing the Server</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/">Contributing to Isso</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/documentation/">Writing Documentation</a></li>
</ul>

          </div>

            <div class="docs">
                
<div class="vcs-edit-container">
<a href="https://github.com/posativ/isso/blob/master/docs/docs/technical-docs/testing-client.rst" class="vcs-edit"><img src="../../../_static/github.svg" /> Edit on GitHub</a>
</div>

                <div role="main">
                
                <section id="testing-the-client">
<h2>Testing the Client<a class="headerlink" href="#testing-the-client" title="Permalink to this headline">¶</a></h2>
<p>The Javascript client part of Isso is tested by the
<a class="reference external" href="https://jestjs.io/">Jest testing framework</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Improvements to Isso’s test coverage and/or different testing strategies are
always welcome! Please see the <a class="reference internal" href="../../contributing/"><span class="doc">Contribute</span></a> page for
further information.</p>
</div>
<p>Sections covered in this document:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#unit-tests" id="id5">Unit tests</a></p></li>
<li><p><a class="reference internal" href="#end-to-end-integration-tests" id="id6">End-to-End Integration tests</a></p>
<ul>
<li><p><a class="reference internal" href="#skip-downloading-chromium" id="id7">Skip downloading Chromium</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#testing-standards" id="id8">Testing standards</a></p>
<ul>
<li><p><a class="reference internal" href="#updating-snapshots" id="id9">Updating snapshots</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="unit-tests">
<h3><a class="toc-backref" href="#id5">Unit tests</a><a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>The unit tests that cover the frontend client ensure that the individual
components are working fine in isolation.</p>
<p>Install the needed <code class="docutils literal notranslate"><span class="pre">Jest</span></code>-related packages
(listed as <code class="docutils literal notranslate"><span class="pre">optionalDependencies</span></code> in <code class="docutils literal notranslate"><span class="pre">package.json</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm install
</pre></div>
</div>
<p>Then run the unit tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm run tests-unit
</pre></div>
</div>
<p>You should receive output that looks similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; test-unit
&gt; jest --config isso/js/jest-unit.config.js isso/js/tests/unit/

PASS  isso/js/tests/unit/isso.test.js
PASS  isso/js/tests/unit/config.test.js
PASS  isso/js/tests/unit/utils.test.js

Test Suites: <span class="m">3</span> passed, <span class="m">3</span> total
Tests:       <span class="m">3</span> passed, <span class="m">3</span> total
Snapshots:   <span class="m">1</span> passed, <span class="m">1</span> total
Time:        <span class="m">0</span>.907 s, estimated <span class="m">1</span> s
Ran all <span class="nb">test</span> suites matching /isso<span class="se">\/</span>js<span class="se">\/</span>tests<span class="se">\/</span>unit<span class="se">\/</span>/i.
</pre></div>
</div>
<p>If you receive an error saying <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">snapshot</span> <span class="pre">failed</span></code> see
<a class="reference internal" href="#updating-snapshots"><span class="std std-ref">Updating snapshots</span></a></p>
</section>
<section id="end-to-end-integration-tests">
<h3><a class="toc-backref" href="#id6">End-to-End Integration tests</a><a class="headerlink" href="#end-to-end-integration-tests" title="Permalink to this headline">¶</a></h3>
<p>For the end-to-end integration tests, the Python server part needs to be up and
running - this part of the test suite pretends to be a real user sitting in
front of a keyboard.</p>
<p>The tests are run using the <a class="reference external" href="https://puppeteer.github.io/puppeteer/">puppeteer</a> browser automation tool. It runs a
real Chromium browser in the background and can be instrumented to allow
simulation of user interaction.</p>
<p>First, ensure all the client files are built and that the server part is ready
to be run. Refer to <a class="reference internal" href="../../reference/installation/#install-from-source"><span class="std std-ref">Install from Source</span></a> for details. Here’s the
important part:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ make init
$ make js
</pre></div>
</div>
<p>Start the server and ensure that the comment database is empty:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mv comments.db comments.db.bak
$ virtualenv .venv
$ <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span> $ isso -c contrib/isso-dev.cfg run
</pre></div>
</div>
<p>Install the necessary <code class="docutils literal notranslate"><span class="pre">puppeteer</span></code>-related Javascript packages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm install --no-save jest jest-puppeteer puppeteer
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This will take some time as a headless <code class="docutils literal notranslate"><span class="pre">chromium</span></code> browser needs to be
downloaded, which requires about 400Mb of space.</p>
</div>
<p>Then run the integration tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm run tests-integration
</pre></div>
</div>
<p>You should receive output that looks similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; test-integration
&gt; jest --config isso/js/jest-integration.config.js isso/js/tests/integration/

PASS  isso/js/tests/integration/puppet.test.js
 ✓ window.Isso functions should be idempotent <span class="o">(</span><span class="m">87</span> ms<span class="o">)</span>
 ✓ should have correct ISSO_ENDPOINT on page <span class="o">(</span><span class="m">26</span> ms<span class="o">)</span>
 ✓ should display <span class="s2">&quot;Isso Demo&quot;</span> text on page <span class="o">(</span><span class="m">34</span> ms<span class="o">)</span>
 ✓ should fill Postbox with valid data and receive <span class="m">201</span> reply <span class="o">(</span><span class="m">319</span> ms<span class="o">)</span>

Test Suites: <span class="m">1</span> passed, <span class="m">1</span> total
Tests:       <span class="m">4</span> passed, <span class="m">4</span> total
Snapshots:   <span class="m">0</span> total
Time:        <span class="m">0</span>.752 s, estimated <span class="m">21</span> s
Ran all <span class="nb">test</span> suites matching /isso<span class="se">\/</span>js<span class="se">\/</span>tests<span class="se">\/</span>integration<span class="se">\/</span>/i.
</pre></div>
</div>
<section id="skip-downloading-chromium">
<h4><a class="toc-backref" href="#id7">Skip downloading Chromium</a><a class="headerlink" href="#skip-downloading-chromium" title="Permalink to this headline">¶</a></h4>
<p>The downloaded browser will be saved to <code class="docutils literal notranslate"><span class="pre">node_modules/puppeteer/.local-chromium/</span></code>.
You can set <code class="docutils literal notranslate"><span class="pre">PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true</span></code> in your environment to
skip downloading the bundled browser and instead use the locally installed
version of Chrome/Chromium via e.g. <code class="docutils literal notranslate"><span class="pre">PUPPETEER_EXECUTABLE_PATH=$(which</span> <span class="pre">chromium)</span></code>.</p>
<p>For further information, see <a class="reference external" href="https://github.com/puppeteer/puppeteer/blob/main/docs/api.md#environment-variables">puppeteer docs: Environment variables</a>.</p>
</section>
</section>
<section id="testing-standards">
<h3><a class="toc-backref" href="#id8">Testing standards</a><a class="headerlink" href="#testing-standards" title="Permalink to this headline">¶</a></h3>
<p>A good starting point are the <a class="reference external" href="https://mailchimp.com/developer/open-commerce/docs/testing-requirements/&gt;">MailChimp standards</a></p>
<p>You may use <code class="docutils literal notranslate"><span class="pre">ES6</span></code> syntax in tests (the restriction for <code class="docutils literal notranslate"><span class="pre">ES5</span></code> syntax is only
for the production client code which needs to run on as many browsers as
possible).</p>
<p>Try not to introduce any race conditions - especially the asynchronous code is
very tricky to get right.</p>
<p>The current test suite was written largely by one of the main project leads,
who happens to know very little about testing (or even Javascript in general).
Feel free to suggest improvements and change this!</p>
<section id="updating-snapshots">
<span id="id4"></span><h4><a class="toc-backref" href="#id9">Updating snapshots</a><a class="headerlink" href="#updating-snapshots" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Jest</span></code> tests make use of <a class="reference external" href="https://jestjs.io/docs/snapshot-testing">snapshots</a>. Say you want to ensure that the Postbox <code class="docutils literal notranslate"><span class="pre">&lt;textarea&gt;</span></code> always looks like this:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;isso-textarea-wrapper&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;isso-textarea isso-placeholder&quot;</span><span class="p">&gt;</span>
      Type Comment Here (at least 3 chars)<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;isso-preview&quot;</span><span class="p">&gt;</span>[...]<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>You <em>could</em> write this as:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">expected_html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;div class=&quot;isso-textarea-wrapper&gt; [...]&#39;</span><span class="p">;</span><span class="w"></span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.isso-textarea-wrapper&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">expected_html</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>But then your resulting test files would quickly grow quite messy, especially
for large components where the <code class="docutils literal notranslate"><span class="pre">expected_html</span></code> block would span whole pages.
That is why <code class="docutils literal notranslate"><span class="pre">Jest</span></code> offers to check in those expected blocks as <code class="docutils literal notranslate"><span class="pre">snapshots</span></code>,
which will saved into e.g. <code class="docutils literal notranslate"><span class="pre">isso/js/tests/unit/__snapshots__/*.snap</span></code></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.isso-textarea-wrapper&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>If you have created a commit which changes the HTML that is generated on the
client side (and you’re sure it is correct) or written a new test case that
uses snapshots, check in or update the snapshot file by running
<code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">run</span> <span class="pre">test-unit</span> <span class="pre">--</span> <span class="pre">-u</span></code>. You should see something like the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>npx jest --config isso/js/jest-unit.config.js isso/js/tests/unit/ -u
PASS  isso/js/tests/unit/isso.test.js
› 1 snapshot updated.
</pre></div>
</div>
<p>Make a new commit for the changes to the snapshot - here’s an example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>isso: tests/unit: Update isso.js snapshot

Prepending `isso-` to the element classes causes a change in
the generated HTML and necessitates an update of the
snapshot.
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This section of the Isso documentation is incomplete. Please help by expanding it.</p>
<p>Click the <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">on</span> <span class="pre">GitHub</span></code> button in the top right corner and read the
GitHub Issue named
<a class="reference external" href="https://github.com/posativ/isso/issues/797">Improve &amp; Expand Documentation</a>
for further information.</p>
<p><strong>What’s missing?</strong></p>
<p>Unit tests:</p>
<ul class="simple">
<li><p>Jest, how to write good tests (link to
<a class="reference external" href="https://mailchimp.com/developer/open-commerce/docs/testing-requirements/">MailChimp standards</a>)</p></li>
<li><p>How to update and check in snapshots</p></li>
</ul>
<p>Integration tests:</p>
<ul class="simple">
<li><p>How Puppeteer works</p></li>
<li><p>How to take advantage of <code class="docutils literal notranslate"><span class="pre">jest-puppeteer</span></code> special <code class="docutils literal notranslate"><span class="pre">expect</span></code> functions</p></li>
</ul>
<p>Running client tests in general:</p>
<ul class="simple">
<li><p>Ways of running tests inside and outside of docker containers</p></li>
<li><p>Link to the GitHub actions that run on every Pull Request</p></li>
</ul>
<p>… and other things about client testing that should be documented.</p>
</div>
</section>
</section>
</section>

                
                </div>
            </div>
        
        </main>

        <div class="push"></div>
    </div>

    <div class="outer footer">
        <footer>
        &copy; Copyright 2022, Martin Zimmermann & contributors.

        Made with <a href="http://sphinx-doc.org/">Sphinx</a>.
        </footer>
    </div>
  </body>
</html>